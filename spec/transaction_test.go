// Copyright Â© 2021 Attestant Limited.
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

package spec_test

import (
	"encoding/json"
	"testing"

	"github.com/attestantio/go-execution-client/spec"
	"github.com/stretchr/testify/require"
)

func TestTransactionJSON(t *testing.T) {
	tests := []struct {
		name  string
		input []byte
		err   string
	}{
		{
			name: "Empty",
			err:  "unexpected end of JSON input",
		},
		{
			name:  "JSONBad",
			input: []byte("[]"),
			err:   "invalid JSON: json: cannot unmarshal array into Go value of type spec.transactionJSON",
		},
		{
			name:  "UnknownType",
			input: []byte(`{"type":"0xff"}`),
			err:   "unhandled transaction type 0xff",
		},
		{
			name:  "GoodType0",
			input: []byte(`{"blockHash":"0x4e3a3754410177e6937ef1f84bba68ea139e8d1a2258c5f85db9f1cd715a1bdd","blockNumber":"0xb443","from":"0xa1e4380a3b1f749673e270229993ee55f35663b4","gas":"0x5208","gasPrice":"0x2d79883d2000","hash":"0x5c504ed432cb51138bcf09aa5e8a410dd4a1e204ef84bfed1be16dfba1b22060","input":"0x","nonce":"0x0","r":"0x88ff6cf0fefd94db46111149ae4bfc179e9b94721fffd821d38d16464b3f71d0","s":"0x45e0aff800961cfce805daef7016b9b675c137a6a41a548f7b60a3484c06a33a","to":"0x5df9b87991262f6ba471f09758cde1c0fc1de734","transactionIndex":"0x0","type":"0x0","v":"0x1c","value":"0x7a69"}`),
		},
		{
			name:  "BadType0",
			input: []byte(`{"blockHash":"0x4e3a3754410177e6937ef1f84bba68ea139e8d1a2258c5f85db9f1cd715a1bdd","blockNumber":"0xb443","from":"0xa1e4380a3b1f749673e270229993ee55f35663b4","gas":"0x5208","gasPrice":"0x2d79883d2000","input":"0x","nonce":"0x0","r":"0x88ff6cf0fefd94db46111149ae4bfc179e9b94721fffd821d38d16464b3f71d0","s":"0x45e0aff800961cfce805daef7016b9b675c137a6a41a548f7b60a3484c06a33a","to":"0x5df9b87991262f6ba471f09758cde1c0fc1de734","transactionIndex":"0x0","type":"0x0","v":"0x1c","value":"0x7a69"}`),
			err:   "hash missing",
		},
		{
			name:  "GoodType1",
			input: []byte(`{"accessList":[],"blockHash":"0xb257c7e147b9dc4a5d9868522f7a7ff0949cd0a11231dd1f2ebe3f66c40982dd","blockNumber":"0xcff0c8","chainId":"0x1","from":"0x46eaadc8f2199463db26d1797131900575f0d264","gas":"0x4fd44","gasPrice":"0x5bf72b4854","hash":"0xc7d73aa9e0e43232010f7e28e4ad333be75f5df04dd1f9a30be80746dc42468b","input":"0xab9d206a0000000000000000000000000000000000000000000000000000000000cff0c80000000000000000000000008c54aa2a32a779e6f6fbea568ad85a19e0109c26000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000031d2054f6200000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001ba01a0b86991c6218b36c1d19d4a2e9eb0ce3606eb480001f4956f47f50a910163d8bf957cf5846d573e7f87ca8c54aa2a32a779e6f6fbea568ad85a19e0109c2600000000000000000000000000000000000000000000000000000031d2054f6294b0a3d511b6ecdb17ebf877278ab030acb0a878000000000000000000000000000000000000000000002d5baff8458b92ac5f8001c02aaa39b223fe8d0a0e5c4f27ead9083c756cc20001f4a0b86991c6218b36c1d19d4a2e9eb0ce3606eb4888e6a0c2ddd26feeb64f039a2c41296fcb3f5640000000000000000000000000000000000000000000000002aea07fa399d7a0008c54aa2a32a779e6f6fbea568ad85a19e0109c2600000000000000000000000000000000000000000000000000000031d2054f620094b0a3d511b6ecdb17ebf877278ab030acb0a87801000000000000000000000000000000000000000000000002afe8dddb94ca63f28698d9d5ea99809c00426484a80be2add4e54581c02aaa39b223fe8d0a0e5c4f27ead9083c756cc288e6a0c2ddd26feeb64f039a2c41296fcb3f5640000000000000000000000000000000000000000000000002aea07fa399d7a000000000000000","nonce":"0xebea","r":"0x901ee907c0a921d816a73cac17405d6745c2354d6b046330780c9f281a995eeb","s":"0x7ccc54f6778c0cdbffed8cf9a1b96ef6b49a6c2e673d585471868ee7b7a9b355","to":"0x8698d9d5ea99809c00426484a80be2add4e54581","transactionIndex":"0x1","type":"0x1","v":"0x0","value":"0x0"}`),
		},
		{
			name:  "BadType1",
			input: []byte(`{"accessList":[],"blockHash":"0xb257c7e147b9dc4a5d9868522f7a7ff0949cd0a11231dd1f2ebe3f66c40982dd","blockNumber":"0xcff0c8","chainId":"0x1","from":"0x46eaadc8f2199463db26d1797131900575f0d264","gas":"0x4fd44","gasPrice":"0x5bf72b4854","input":"0xab9d206a0000000000000000000000000000000000000000000000000000000000cff0c80000000000000000000000008c54aa2a32a779e6f6fbea568ad85a19e0109c26000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000031d2054f6200000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001ba01a0b86991c6218b36c1d19d4a2e9eb0ce3606eb480001f4956f47f50a910163d8bf957cf5846d573e7f87ca8c54aa2a32a779e6f6fbea568ad85a19e0109c2600000000000000000000000000000000000000000000000000000031d2054f6294b0a3d511b6ecdb17ebf877278ab030acb0a878000000000000000000000000000000000000000000002d5baff8458b92ac5f8001c02aaa39b223fe8d0a0e5c4f27ead9083c756cc20001f4a0b86991c6218b36c1d19d4a2e9eb0ce3606eb4888e6a0c2ddd26feeb64f039a2c41296fcb3f5640000000000000000000000000000000000000000000000002aea07fa399d7a0008c54aa2a32a779e6f6fbea568ad85a19e0109c2600000000000000000000000000000000000000000000000000000031d2054f620094b0a3d511b6ecdb17ebf877278ab030acb0a87801000000000000000000000000000000000000000000000002afe8dddb94ca63f28698d9d5ea99809c00426484a80be2add4e54581c02aaa39b223fe8d0a0e5c4f27ead9083c756cc288e6a0c2ddd26feeb64f039a2c41296fcb3f5640000000000000000000000000000000000000000000000002aea07fa399d7a000000000000000","nonce":"0xebea","r":"0x901ee907c0a921d816a73cac17405d6745c2354d6b046330780c9f281a995eeb","s":"0x7ccc54f6778c0cdbffed8cf9a1b96ef6b49a6c2e673d585471868ee7b7a9b355","to":"0x8698d9d5ea99809c00426484a80be2add4e54581","transactionIndex":"0x1","type":"0x1","v":"0x0","value":"0x0"}`),
			err:   "hash missing",
		},
		{
			name:  "GoodType2",
			input: []byte(`{"accessList":[{"address":"0xceff51756c56ceffca006cd410b03ffc46dd3a58","storageKeys":["0x0000000000000000000000000000000000000000000000000000000000000008","0x0000000000000000000000000000000000000000000000000000000000000009","0x0000000000000000000000000000000000000000000000000000000000000007","0x000000000000000000000000000000000000000000000000000000000000000a","0x000000000000000000000000000000000000000000000000000000000000000c","0x0000000000000000000000000000000000000000000000000000000000000006"]},{"address":"0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2","storageKeys":["0x96693869bd9caff1b0916c4e11fe79467174d34d9d4aad910b52d5a6333d2192","0x30bd84b96629f958113934633d3bd1b64c3d259a85c57ceac65da8c5ec9bf3a7"]},{"address":"0xf424018c3d4473e014c1def44171772059f2d720","storageKeys":[]},{"address":"0x2260fac5e5542a773aa44fbcfedf7c193bc2c599","storageKeys":["0x14ac31782b75d0b8926aa44db6f6caf09df8257632d9c607f23247258a0f6d0b","0x631603854828263717f78aebdf44701ab316ae3c9d57ea74169f98df3affd293","0x0000000000000000000000000000000000000000000000000000000000000005","0xf7c84b5d1f3a0563cd20b346c00dcaaaf749870e80d340ce8dc6213863709a60"]}],"blockHash":"0xb257c7e147b9dc4a5d9868522f7a7ff0949cd0a11231dd1f2ebe3f66c40982dd","blockNumber":"0xcff0c8","chainId":"0x1","from":"0x9ce3ce3978cbee75df235a499503d719da697ceb","gas":"0x61a80","gasPrice":"0x1b301f66ae","hash":"0x3eb2f1bc543ced1004437c75ba58f2bd03b7b3592ef96da57808e9460c18cd01","input":"0x1cff79cd000000000000000000000000f424018c3d4473e014c1def44171772059f2d720000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000001042fdc7315000000000000000000000000ceff51756c56ceffca006cd410b03ffc46dd3a580000000000000000000000002260fac5e5542a773aa44fbcfedf7c193bc2c59900000000000000000000000056178a0d5f301baf6cf3e1cd53d9863437345bf900000000000000000000000000000000000000000000000000000004f74ba90000000000000000000000000000000000000000000012a25c7039192ee0d8a8000000000000000000000000000000000000000001c67aff541cec1086a24edef4000000000000000000000000000000000000000000000000000000006193d9fe330000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000","maxFeePerGas":"0x1dd855f4d2","maxPriorityFeePerGas":"0x0","nonce":"0x8d89","r":"0x979132c4f106dfc44eb3ea9e24e654a6d73fd8f9081daa2b0576b6ec8bbe6e79","s":"0x461093462822fd309b9d20add4886fc4a76a190c97cb0779a26475cefbd81bce","to":"0xa57bd00134b2850b2a1c55860c9e9ea100fdd6cf","transactionIndex":"0x2","type":"0x2","v":"0x1","value":"0x0"}`),
		},
		{
			name:  "BadType2",
			input: []byte(`{"accessList":[{"address":"0xceff51756c56ceffca006cd410b03ffc46dd3a58","storageKeys":["0x0000000000000000000000000000000000000000000000000000000000000008","0x0000000000000000000000000000000000000000000000000000000000000009","0x0000000000000000000000000000000000000000000000000000000000000007","0x000000000000000000000000000000000000000000000000000000000000000a","0x000000000000000000000000000000000000000000000000000000000000000c","0x0000000000000000000000000000000000000000000000000000000000000006"]},{"address":"0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2","storageKeys":["0x96693869bd9caff1b0916c4e11fe79467174d34d9d4aad910b52d5a6333d2192","0x30bd84b96629f958113934633d3bd1b64c3d259a85c57ceac65da8c5ec9bf3a7"]},{"address":"0xf424018c3d4473e014c1def44171772059f2d720","storageKeys":[]},{"address":"0x2260fac5e5542a773aa44fbcfedf7c193bc2c599","storageKeys":["0x14ac31782b75d0b8926aa44db6f6caf09df8257632d9c607f23247258a0f6d0b","0x631603854828263717f78aebdf44701ab316ae3c9d57ea74169f98df3affd293","0x0000000000000000000000000000000000000000000000000000000000000005","0xf7c84b5d1f3a0563cd20b346c00dcaaaf749870e80d340ce8dc6213863709a60"]}],"blockHash":"0xb257c7e147b9dc4a5d9868522f7a7ff0949cd0a11231dd1f2ebe3f66c40982dd","blockNumber":"0xcff0c8","chainId":"0x1","from":"0x9ce3ce3978cbee75df235a499503d719da697ceb","gas":"0x61a80","gasPrice":"0x1b301f66ae","input":"0x1cff79cd000000000000000000000000f424018c3d4473e014c1def44171772059f2d720000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000001042fdc7315000000000000000000000000ceff51756c56ceffca006cd410b03ffc46dd3a580000000000000000000000002260fac5e5542a773aa44fbcfedf7c193bc2c59900000000000000000000000056178a0d5f301baf6cf3e1cd53d9863437345bf900000000000000000000000000000000000000000000000000000004f74ba90000000000000000000000000000000000000000000012a25c7039192ee0d8a8000000000000000000000000000000000000000001c67aff541cec1086a24edef4000000000000000000000000000000000000000000000000000000006193d9fe330000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000","maxFeePerGas":"0x1dd855f4d2","maxPriorityFeePerGas":"0x0","nonce":"0x8d89","r":"0x979132c4f106dfc44eb3ea9e24e654a6d73fd8f9081daa2b0576b6ec8bbe6e79","s":"0x461093462822fd309b9d20add4886fc4a76a190c97cb0779a26475cefbd81bce","to":"0xa57bd00134b2850b2a1c55860c9e9ea100fdd6cf","transactionIndex":"0x2","type":"0x2","v":"0x1","value":"0x0"}`),
			err:   "hash missing",
		},
	}

	for _, test := range tests {
		t.Run(test.name, func(t *testing.T) {
			var res spec.Transaction
			err := json.Unmarshal(test.input, &res)
			if test.err != "" {
				require.EqualError(t, err, test.err)
			} else {
				require.NoError(t, err)
				rt, err := json.Marshal(&res)
				require.NoError(t, err)
				require.Equal(t, string(test.input), string(rt))
			}
		})
	}
}
